<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;application/json; charset=UTF-8" />
     <link rel="stylesheet" type="text/css" href="style.css" />
    <title><%= sodienthoai %></title>
    <script src="jquery-3.1.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
var socket = io("https://epos188.herokuapp.com/");
socket.connect();
var map;
var mangmarker = [];
var marker1 = {};
var list_nguoinhan = [];
var list_diem_gui_di = [];
var id_posname=1;
var mang_infowindow = [];
var mang_infowindow_main = [];
var ten="";
var mang_kq_contact_search = [];
var id_mang_kq_contact_search=0;
var mang_contact_ok = [];
var id_mang_contact_ok=0;
var check_del = true;
var number_del_inbox = 0; // biến này để đếm số lượng đã chọn trong các mục để xóa
function strdecode( data ) {
  return decodeURIComponent(escape( data ));
}
var id_inbox_pos=0;
var id_contact = 0;
var mang_inbox = [];
var mang_send = [];
var mang_save = [];
var mang_contact = [];
var mang_contact_ok = [];
var mang_room = [];
var list_del = [];
var trangthai_yeucau_data = "full";

socket.on('check_pass',()=>{
   socket.emit('login2','<%= sodienthoai %>', '<%= pass %>');

});
socket.on('login2_dung',()=>{
  if(trangthai_yeucau_data === "full"){socket.emit('C_yeucau_data_full','web');}
  else {socket.emit('C_yeucau_data_new','web');}
});
socket.on('S_W_kq_check_contact',function(data){
      // var number = data.number;
      // var user1 = data.user;
      // id_mang_kq_contact_search = id_mang_kq_contact_search +1;
      // mang_kq_contact_search.push({id:id_mang_kq_contact_search,number:data.number, user:data.user});
      // if (ten.length ==94){
      //   ten="<div><div class='line_contact1_wrap'><a href='#' onclick='them_contact2("+id_mang_kq_contact_search+")' class='line_contact1'>"+data.user+"</a></div>"+
      //   "<div class='line_contact2_wrap'><a href='#' onclick='add_friend("+id_mang_kq_contact_search+")'>Add friend</a></div></div></br>";
      // }
      // else {
      //   ten = ten+ "<div><div class='line_contact1_wrap'><a href='#' onclick='them_contact2("+id_mang_kq_contact_search+")' class='line_contact1'>"+data.user+"</a></div>"+
      // "<div class='line_contact2_wrap'><a href='#'>Add friend</a></div></div></br>";
      // }
      // // $("#my_list_contact").html( ten);
      // $("#my_list_contact").html( ten);
      var dropdowns = document.getElementsByClassName("list_contact_1");
      var k;
      for (k = 0; k < dropdowns.length; k++) {
      var openDropdown = dropdowns[k];
      if (!(openDropdown.classList.contains('show1'))) {
       document.getElementById("my_list_contact").classList.toggle("show1");
      }
      }

    });
socket.on('S_pos_online', function(data){
              if (mangmarker.length == 0){
          var  marker2 = new google.maps.Marker({
                      position: { lat: data.lat, lng: data.lon },
                      label: data.name,
                      map: map,
                    });
                    marker1 = {marker:marker2, name:data.name, number:data.number};
                    mangmarker.push(marker1);
                  }
            else {
               var test = true;
              mangmarker.forEach(function(mar){
                 if (mar.number == data.number){
                 //  // nếu đã có điểm rồi thì chỉ cập nhật điểm đó thôi
                 var latlng = new google.maps.LatLng(data.lat, data.lon);
                   mar.marker.setPosition(latlng);
                 //  test= false;
                 //  break;
                  }
              });

             }
          });
socket.on('S_send_room_member', function(data){
                    var ten ="";

                    data.forEach(function(member){
                      ten = ten+ "<a href='#' onclick='show_vitri_thanhvien("+member.number+");'>"+member.name + "</a>";
                      });

                      $("#myDropdown6").html( ten);
                  });
socket.on('S_send_inbox', (data)=>{
     //S gửi toàn bộ bản tin inbox về client
     trangthai_yeucau_data = "new";
     var trangthai="";
       data.forEach((row)=>{
         var thoigian="";
         if(row.stt === "N"){socket.emit("danhantinnhan","web",row.number_nguoigui,row.id_tinnha_client);}
         id_inbox_pos++;
         var idc = "4"+id_inbox_pos;
         var tin = {id_pos:idc, name_nguoigui:strdecode(row.name_nguoigui),number_nguoigui:row.number_nguoigui, subject:strdecode(row.subject), id_tinnha_client:row.id_tinnha_client,trangthai:row.trangthai, stt: row.stt, thoigian:show_time(row.time) };
         mang_inbox.push(tin);
         if(row.trangthai==="N"){trangthai="Not read";}
         else {trangthai="";}
         var line = "<div class='line_inbox'><input type='checkbox' id='"+idc+"' class='line_inbox_chk' onclick='checkbox_inbox_click("+idc+");'><div class='line_inbox_main' onclick='inbox_click("+idc+")'><div class='line_inbox_sub'>"+strdecode(row.subject)+"</div><div class='line_inbox_time'>"+show_time(row.time)+"</div><div class='line_inbox_from'>From:"+strdecode(row.name_nguoigui)+"</div><div class='line_inbox_read'>"+trangthai+"</div></div></div>";
        $("#k_inbox").prepend(line);

       });
     socket.emit('C_nhan_inbox');
});
socket.on('S_send_send', (data)=>{
     //S gửi toàn bộ bản tin send về client
     trangthai_yeucau_data = "new";
       data.forEach((row)=>{
         var thoigian="";
         var ab = "";
         var space = "";
         id_inbox_pos++;
         var idc = "3"+id_inbox_pos;
         var tin = {id_pos:idc, nhom_nguoinhan:row.nguoinhan, subject:strdecode(row.subject), id_tinnha_client:row.idc, thoigian:show_time(row.time) };
         mang_send.push(tin);
         row.nguoinhan.forEach((row1,key)=>{
              if(key===(row.nguoinhan.length-1)){space="";}else {space=" ,";}
              if(row1.stt ==="N"){ab=ab+"<font color='red'>"+strdecode(row1.name)+"</font>" +space;}else {ab=ab+strdecode(row1.name)+space;}
          });
          var line = "<div class='line_inbox'><input type='checkbox' id='"+idc+"' class='line_send_chk' onclick='checkbox_send_click("+idc+");'><div class='line_send_main' onclick='send_click("+idc+")'><div class='line_send_sub'>"+strdecode(row.subject)+"</div><div class='line_send_time'>"+show_time(row.time)+"</div><div class='line_send_from'>To:"+ab+"</div><div class='line_send_read'>ha ha</div></div></div>";
          $("#k_send").prepend(line);
       });
      socket.emit('C_nhan_send');
});
socket.on('S_send_save', (data)=>{
     //S gửi toàn bộ bản tin inbox về client
     trangthai_yeucau_data = "new";
       data.forEach((row,key)=>{
         var thoigian="";
         id_inbox_pos++;
         var idc = "2"+id_inbox_pos;
         var tin = {id_pos:idc, subject:strdecode(row.subject), id_tinnha_client:row.idc, time:show_time(row.time) };
         mang_save.push(tin);
        var line = "<div class='line_inbox'><input type='checkbox' id='"+idc+"' class='line_save_chk' onclick='checkbox_save_click("+idc+");'><div class='line_save_main' onclick='save_click("+idc+")'><div class='line_save_sub'>"+strdecode(row.subject)+"</div><div class='line_inbox_time'>"+show_time(row.time)+"</div></div></div>";
          $("#k_save").before(line);

       });
     socket.emit('C_nhan_save');
});
socket.on('S_send_contact',(data)=>{
  trangthai_yeucau_data = "new";
  data.forEach((tin)=>{
    id_contact ++;
    var idc = "1"+id_contact;
    mang_contact.push({id: idc, name: tin.name, number:tin.number});
    var line = "<div class='list_contact_main_line'><div style='position:absolute;' id='list_contact_name'>"+strdecode(tin.name)+"</div><div class='list_contact_line_number' id='list_contact_number'>"+tin.number+"</div><button class='list_contact_line_btn' id='btn"+idc+"' onclick='add_contact_click("+idc+")'>Add</button></div>";
      $("#id_list_contact").append(line);
  });
});
socket.on('S_send_room',(data)=>{
  id_inbox_pos++;
  var idc = "5"+id_inbox_pos;
  var tin = {id_pos:idc, name_nguoigui:strdecode(data.admin_name),number_nguoigui:data.admin_number, subject:strdecode(data.room_name), room_id:data.room_id_server, thoigian:show_time(data.time)};
  mang_room.push(tin);
  var line = "<div class='line_inbox'><input type='checkbox' id='"+idc+"' class='line_inbox_chk' onclick='checkbox_room_click("+idc+");'><div class='line_inbox_main' onclick='room_click("+idc+")'><div class='line_inbox_sub'>"+strdecode(data.room_name)+"</div><div class='line_inbox_time'>"+show_time(data.time)+"</div><div class='line_inbox_from'>From:"+strdecode(data.admin_name)+"</div><div class='line_inbox_read'></div></div></div>";
  $("#k_online").prepend(line);
  socket.emit('C_get_room','web',data.room_id_server);
});
socket.on('S_W_add_friend_ok',function(data){
              var new_contact = "<a href=''>"+data.name+"</a></br>";
             $("#myDropdown_contact").append(new_contact);
             var stt = mang_contact_ok.length;
             mang_contact_ok.push({id:data.id,number:data.number, name:data.name});



          });
socket.on('S_del_inbox', ()=>{
    // xóa row trong list_inbox
    document.getElementById("del_inbox").style.marginTop = "-25px";
    $("#item_inbox_chose").html("");
    list_del.forEach((row, key)=>{
      for(var i=0; i< mang_inbox.length; i++){
        if(mang_inbox[i].id_tinnha_client===row.idc){
          document.getElementById("full"+mang_inbox[i].id_pos).remove();
          mang_inbox.splice(i,1);
          if(key===list_del.length){list_del= [];}
          return false;
        }
      }
    });
    // bỏ cái hàng với cái id kia
    // document.getElementById(id1).remove();
    alert('Tin nhắn đã được xóa thành công');
});
socket.on('S_send_point',(data)=>{
  $("#id_location_list").html("");
  if(mang_infowindow.length > 0){
    mang_infowindow.forEach((win,key)=>{
    win.wind.close();
    if(key === (mang_infowindow.length-1)){
      mang_infowindow = [];
      mang_infowindow_main=[];
      data.forEach((tin)=>{
        show_pos(tin.lat, tin.lon, strdecode(tin.name), tin.id);
        var line = "<div class='list_line' id='li_lo"+tin.id+"'><div class='lo_list_sub' onclick='fly_to("+tin.id+")'>"+strdecode(tin.name)+"</div><input type='checkbox' class='list_line_checkbox' id='chk"+tin.id+"' onchange='hide_show_pos("+tin.id+")'><div class='lo_list_show'>Hide</div></div>";
        $("#id_location_list").append(line);
      });
    }
  });
  }
  else {data.forEach((tin)=>{
    show_pos(tin.lat, tin.lon, strdecode(tin.name),tin.id);
    var line = "<div class='list_line' id='li_lo"+tin.id+"'><div class='lo_list_sub' onclick='fly_to("+tin.id+")'>"+strdecode(tin.name)+"</div><input type='checkbox' class='list_line_checkbox' id='chk"+tin.id+"' onchange='hide_show_pos("+tin.id+")'><div class='lo_list_show'>Hide</div></div>";
    $("#id_location_list").append(line);

  });
  }
});
socket.on('S_guitinnhan', (data)=>{
  id_inbox_pos++;
  var idc = "4"+id_inbox_pos;
  var tin = {id_pos:idc, name_nguoigui:strdecode(data.name_nguoigui),number_nguoigui:data.number_nguoigui, subject:strdecode(data.subject), id_tinnha_client:data.id_tinnha_client,trangthai:"N", stt: data.stt, thoigian:show_time(data.time) };
  mang_inbox.push(tin);
  var line = "<div class='line_inbox'><input type='checkbox' id='"+idc+"' class='line_inbox_chk' onclick='checkbox_inbox_click("+idc+");'><div class='line_inbox_main' onclick='inbox_click("+idc+")'><div class='line_inbox_sub'>"+strdecode(data.subject)+"</div><div class='line_inbox_time'>"+show_time(data.time)+"</div><div class='line_inbox_from'>From:"+strdecode(data.name_nguoigui)+"</div><div class='line_inbox_read'>"+"Not read"+"</div></div></div>";
 $("#k_inbox").prepend(line);
  socket.emit("danhantinnhan", "web",data.number_nguoigui, data.id_tinnha_client);
});
socket.on('S_get_tinnhan',(data, abc)=>{
  id_inbox_pos++;
  socket.emit('S_get_tinnhan_ok','web',data.idc);
  var ab = "";
  var space = "";
  var idc = "3"+id_inbox_pos;
  var tin = {id_pos:idc, nhom_nguoinhan:data.nguoinhan, subject:strdecode(data.subject), id_tinnha_client:data.idc, thoigian:show_time(data.time) };
  mang_send.push(tin);
  data.nguoinhan.forEach((row1,key)=>{
     if(key===(data.nguoinhan.length-1)){space="";}
     else {space = ";";}
     ab=ab+"<font color='red'>"+strdecode(row1.name)+"</font>" +space;
   });
  var line = "<div class='line_inbox' id='send"+idc+"'><input type='checkbox' id='"+idc+"' class='line_send_chk' onclick='checkbox_send_click("+idc+");'><div class='line_send_main' onclick='send_click("+idc+")'><div class='line_send_sub'>"+strdecode(data.subject)+"</div><div class='line_send_time'>"+show_time(data.time)+"</div><div class='line_send_from'>To:"+ab+"</div><div class='line_send_read'></div></div></div>";
   $("#k_send").prepend(line);
});
// io.sockets.in(nguoigui).emit('C_danhantinnhan',{nguoinhan:socket.number,tennguoinhan:strencode(socket.username), idc:idc});
socket.on('C_danhantinnhan',(data)=>{
  mang_send.forEach((tin)=>{
    if(tin.id_tinnha_client ===data.idc){
      let ab = "";
      let space="";
      tin.nhom_nguoinhan.forEach((row,key)=>{
         if(key===(tin.nhom_nguoinhan.length-1)){space="";}else {space = "; ";}
         if(row.number === data.nguoinhan){ab=ab+strdecode(row.name)+space;row.stt='Y';}
         else {
           if(row.stt ==='N'){ab=ab+"<font color='red'>"+strdecode(row.name)+"</font>" +space;}
           else {ab=ab+strdecode(row.name)+space;}

         }
      });
      var line = "<div class='line_inbox' id='send"+tin.id_pos+"'><input type='checkbox' id='"+tin.id_pos+"' class='line_send_chk' onclick='checkbox_send_click("+tin.id_pos+");'><div class='line_send_main' onclick='send_click("+tin.id_pos+")'><div class='line_send_sub'>"+strdecode(tin.subject)+"</div><div class='line_send_time'>"+tin.thoigian+"</div><div class='line_send_from'>To:"+ab+"</div><div class='line_send_read'></div></div></div>";
      $("#send"+tin.id_pos).html(line);
      socket.emit("tinnhan_final", "web",data.idc, data.nguoinhan);
      return false;
    }
  });
  // chuyển đổi màu sắc sang đỏ đối với người

});
function hide_show_pos(id){
  if(document.getElementById("chk"+id).checked == true){cancle_luudiem(id);}
  else {
    for (var i=0; i<mang_infowindow_main.length; i++){
      if(mang_infowindow_main[i].id ==id){
        var lat1 = mang_infowindow_main[i].lat;
        var lon1 = mang_infowindow_main[i].lon;
        var name1 = mang_infowindow_main[i].name;
        var infowindow = new google.maps.InfoWindow({
            position:{ lat:lat1, lng:lon1},
            content:name1
        });
          // infowindow.setContent(name1);
          infowindow.open(map);
          var win = {id:id, wind: infowindow};
          mang_infowindow.push(win);
          google.maps.event.addListener(infowindow, 'closeclick', function() {
            document.getElementById("li_lo"+id).remove();
            for(var i=0; i<mang_infowindow.length; i++){
              if(mang_infowindow[i].id == id){
                mang_infowindow.splice(i,1);
                break;
              }
            }
            for(var i=0; i<mang_infowindow_main.length; i++){
              if(mang_infowindow_main[i].id == id){
                mang_infowindow_main.splice(i,1);
                break;
              }
            }

          });
      break;
        }
      }
  }
}
function show_pos(lat,lon, name, id1){
  var infow = new google.maps.InfoWindow({
      position:{ lat:lat, lng: lon},
      content:name
    });
    // infow.setContent(name);
    // var win = {id:id1, wind: infow};
    mang_infowindow_main.push({name:name,lat:lat,lon:lon,id:id1});
    mang_infowindow.push({id:id1, wind: infow});
    infow.open(map);
    google.maps.event.addListener(infow,'closeclick',function(){
      document.getElementById("li_lo"+id1).remove();
      for (var i=0; i<mang_infowindow.length; i++){
        if(mang_infowindow[i].id == id1){
          mang_infowindow.splice(i,1);
          break;
        }
      }
      for (var k=0; k<mang_infowindow_main.length; k++){
        if(mang_infowindow_main[k].id == id1){
          mang_infowindow_main.splice(k,1);
          break;
        }
      }
  });

}
function fly_to(id){
  mang_infowindow.forEach((tin)=>{
    if(tin.id == id){
      var center = new google.maps.LatLng(tin.wind.getPosition().lat(),tin.wind.getPosition().lng());
       map.panTo(center);
       map.setZoom(15);
      return false;
    }
  });
}
function handleChange(checkbox,id1) {
    if(checkbox.checked == true){
      cancle_luudiem(id1);
    }else{
      for (var i=0; i<mang_infowindow_main.length; i++){
        if(mang_infowindow_main[i].id ==id1){
          var lat1 = mang_infowindow_main[i].lat;
          var lon1 = mang_infowindow_main[i].lon;
          var name1 = mang_infowindow_main[i].name;
          var infowindow = new google.maps.InfoWindow({
              position:{ lat:lat1, lng:lon1}
          });
            infowindow.setContent(name1);
            infowindow.open(map);
            var win = {id:id1, wind: infowindow};
            mang_infowindow.push(win);
            google.maps.event.addListener(infowindow, 'closeclick', function() {$("#"+id1).html("");});
        return false;
          }
        }
   }
}
function guitinnhan(){
    var sub = document.getElementById("id_input_subject").value.trim();
    if ( sub === ""){
    alert('There is no subjet.');
  }
    else {
    if (mang_contact_ok.length ==0){
      alert('There is no receiver.');
    }
    else {
      if (mang_infowindow_main.length == 0){
        alert('There is no position in map to send.');
      }
      else {
        var ma1 = Math.floor(Math.random()*(9000)+1000);
        var ma2 =Math.floor(Math.random()*(9000)+1000);
        var mafull = ""+ma1+ma2;
        var ten = "<%= name %>";
        var sodienthoai = "<%= sodienthoai %>";
        var tinnhanfull = {nguoigui_name: ten, nguoigui_number:sodienthoai ,subject: sub  ,nguoinhan:mang_contact_ok, pos:mang_infowindow_main, id:mafull};
        socket.emit('C_gui_tinnhan','web',tinnhanfull);
      }
    }
  }
}
function test(){
  // document.getElementById("del_inbox").style.marginTop = "0px";
    // $("#id_list_pos").append(new_pos);
  // mang_infowindow.forEach((item)=>{
  //   item.wind.close();
  // });
  alert(mang_infowindow_main.length);
}
function test2(){
    alert(mang_infowindow.length);
}
function open_close_list(){
  if(document.getElementById("id_btn_list").textContent === "List"){
    document.getElementById("id_right_bar").style.right = "0px";
      $("#id_btn_list").html("Hide");
  }
  else {
    document.getElementById("id_right_bar").style.right = "-250px";
      $("#id_btn_list").html("List");
  }
}
function myMap() {
      var mapOptions = {
      center: new google.maps.LatLng(41.5, -0.12),
      zoom: 10,
      // mapTypeId: google.maps.MapTypeId.HYBRID,
      scrollwheel: true,
      navigationControl: true,
      scaleControl: true,
      draggable: true,
      disableDoubleClickZoom: true,
      fullscreenControl: false,
      mapTypeControl:  true,
      rotateControl: true,
      mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.VER_BAR,position: google.maps.ControlPosition.BOTT_LEFT,},}
      $(document).ready(function(){
          map = new google.maps.Map(document.getElementById("map"), mapOptions);
          map.setTilt(45);
          google.maps.event.addListener(map, "rightclick", function(event) {
            map_rightclick(event.latLng.lat(),event.latLng.lng());
          });

         });
}
function map_rightclick( lat1, lon1){
  var id =  new Date().getTime();
  var infowindow = new google.maps.InfoWindow({
      position:{ lat:lat1, lng: lon1}
    });
    var noidung=  "<div class='info_wrap'><div>Input name of this place</div><input type='text' id='input_123' class='info_input'></input>"+
    "<div class='posname_2'><button onclick='cancle_luudiem("+id+")' class='info_cancle'>CANCLE</button>"+
    "<button onclick='luudiem("+lat1+","+lon1+","+id+")' class='info_ok'>OK</button></div></div>";
    infowindow.setContent(noidung);
    infowindow.open(map);
    var win = {id:id, wind: infowindow};
    mang_infowindow.push(win);
}
function luudiem(lat1, lon1, id1){
  var name1 = document.getElementById("input_123").value;
  for (var i=0; i<mang_infowindow.length; i++){
    if(mang_infowindow[i].id ==id1){
      mang_infowindow[i].wind.setContent(name1);
      var diem2 = {name:name1, lat:lat1, lon:lon1, id:id1};
      mang_infowindow_main.push(diem2);
      var line = "<div class='list_line' id='li_lo"+id1+"'><div class='lo_list_sub' onclick='fly_to("+id1+")'>"+name1+"</div><input type='checkbox' class='list_line_checkbox' id='chk"+id1+"' onchange='hide_show_pos("+id1+")'><div class='lo_list_show'>Hide</div></div>";
      $("#id_location_list").append(line);
      // var new_pos = "<div id='"+id1+"' class='line_list_pos'><div onclick='fly_to("+id1+")' style='position:absolute; left:0px,color:#4d4dff; cursor:pointer;overflow:hidden;max-width:150px'>"+name1+"</div><div style='position:absolute; right:0px'><input id='input"+id1+"' type='checkbox' onchange='handleChange(this,"+id1+")'><span style='font-size: 20px;'>Hide</span></div></br></div>";
      // $("#id_list_pos").append(new_pos);

      google.maps.event.addListener(mang_infowindow[i].wind,'closeclick',function(){
        document.getElementById("li_lo"+id1).remove();
        for (var i=0; i<mang_infowindow.length; i++){
          if(mang_infowindow[i].id == id1){
            mang_infowindow.splice(i,1);
            break;
          }
        }
        for (var k=0; k<mang_infowindow_main.length; k++){
          if(mang_infowindow_main[k].id == id1){
            mang_infowindow_main.splice(k,1);
            break;
          }
        }
    });
      return false;
      }
    }
}
function cancle_luudiem(id) {
  for (var i=0; i<mang_infowindow.length; i++){
    if(mang_infowindow[i].id ==id){
    mang_infowindow[i].wind.close();
    mang_infowindow.splice(i, 1);
    return false;
      }
    }

  }
function show_time(time) {
  let year = time.year;
  let month=time.month;
  let day = time.day;
  let hr = time.hr;
  let min = time.min;
  let sec = time.sec;
  let zone = time.time_zone;
  let day1 = new Date(year, month, day, hr, min, sec);
  let C_zone  = new Date().getTimezoneOffset();
  day1.setMinutes(day1.getMinutes()+zone - C_zone);
  return day1.getFullYear()+" "+(day1.getMonth()+1)+"/"+day1.getDate()+" "+day1.getHours()+":"+day1.getMinutes()+":"+day1.getSeconds();

}
function inbox_click(id){
  mang_inbox.forEach((tin)=>{
    if(tin.id_pos == id){
      socket.emit('C_reques_point_inbox',tin.id_tinnha_client);
      return false;
    }
  });
}
function save_click(id){
  mang_save.forEach((tin)=>{
    if(tin.id_pos == id){
      socket.emit('C_reques_point',tin.id_tinnha_client);
      return false;
    }
  });
}
function send_click(id){
  mang_send.forEach((tin)=>{
    if(tin.id_pos == id){
      socket.emit('C_reques_point',tin.id_tinnha_client);
      return false;
    }
  });
}
function search_contact(){
  document.getElementById("id_list_contact").style.display = "none";
  $("#id_list_contact_search").html("");
  var chuoi = document.getElementById("id_input_contact").value.trim();
  if (chuoi.charAt(0)=='0'){chuoi = chuoi.substr(1);}
  if (chuoi.length>0){
    document.getElementById("id_list_contact_search").style.display = "block";
    var kiemtra = true;
    for (var i=0; i<mang_contact.length; i++){
      if  ( strdecode(mang_contact[i].name).toLowerCase().indexOf(chuoi.toLowerCase()) !== -1 || mang_contact[i].number.toLowerCase().indexOf(chuoi.toLowerCase()) !== -1){
        var line = "<div class='list_contact_main_line'><div style='position:absolute;' id='list_contact_name'>"+strdecode(mang_contact[i].name)+"</div><div class='list_contact_line_number' id='list_contact_number'>"+mang_contact[i].number+"</div><button class='list_contact_line_btn' id='bt"+mang_contact[i].id+"' onclick='add_contact__search_click("+mang_contact[i].id+")'>"+document.getElementById("btn"+mang_contact[i].id).textContent+"</button></div>";
          $("#id_list_contact_search").append(line);
          kiemtra = false;
        }
    }
      if (kiemtra){
          $("#id_list_contact_search").html("");
        // nếu không tìm thấy trong list contact hiện hữu thì sẽ tìm trên server
        // ten = "There is no item found in your listcontact. </br>Please input more letter to search in Global.";
        // $("#my_list_contact").html( ten);
        // var abc = ""+ten.length;
        // if (chuoi.trim().length >5){
        // socket.emit('W_check_contact',chuoi);
        // }
      }
  }
  else { document.getElementById("id_list_contact_search").style.display = "none";}
}
function add_contact__search_click(id){
  var x = document.getElementById("bt"+id).textContent;
  if(x === "Add"){
    mang_contact.forEach((row,key)=>{
      if(row.id == id){
        mang_contact_ok.push({id:id, name:strdecode(row.name), number:row.number});
        var line = "<div class='list_contact_ok_item' id='"+id+"'><div class='a111'>"+strdecode(row.name)+"</div><button class='a222' onclick='del_contact_ok("+id+")'>X</button></div>";
        $("#id_list_contact_ok").append(line);
        return false;
      }
    });
    $("#btn"+id).html("Move");
    $("#bt"+id).html("Move");
  }
  else {
    del_contact_ok(id);
    $("#btn"+id).html("Add");
    $("#bt"+id).html("Add");
  }
}
function add_contact_click(id){
  var x = document.getElementById("btn"+id).textContent;
  if(x === "Add"){
    mang_contact.forEach((row,key)=>{
      if(row.id == id){
        mang_contact_ok.push({id:id, name:strdecode(row.name), number:row.number});
        var line = "<div class='list_contact_ok_item' id='"+id+"'><div class='a111'>"+strdecode(row.name)+"</div><button class='a222' onclick='del_contact_ok("+id+")'>X</button></div>";
        $("#id_list_contact_ok").append(line);
        return false;
      }
    });
    $("#btn"+id).html("Move");
  }
  else {
    del_contact_ok(id);
    $("#btn"+id).html("Add");
  }
}
function del_contact_ok(id){
  document.getElementById(id).remove();
  $("#btn"+id).html("Add");
   for(var i=mang_contact_ok.length-1; i >=0 ; i--){
     if(mang_contact_ok[i].id == id){
       mang_contact_ok.splice(i, 1);
       return false;
     }
   }

}
function xoadiem_inbox(){
  list_del = [];
  var list_checkbox = document.getElementsByClassName("line_inbox_chk");
    // $("#id_btn_send").html(list_checkbox[2].id);
  for (var i = 0; i < list_checkbox.length; i++) {
    if(list_checkbox[i].checked){
      mang_inbox.forEach((row1, key)=>{
        // nếu hàng đó có chọn thì sẽ lấy cái id của hàng đó, rồi tìm trong mảng, lấy cái id tin nhắn ra
        // đưa vào danh sách gửi đi.
        if(row1.id_pos==list_checkbox[i].id){
          list_del.push({idc:row1.id_tinnha_client});
          return false;
        }
        })
    }
    }
    if(list_del.length>0){
      var item="";
      if (list_del.length>1){item = "items";}else{item="item";}
      var r = confirm(list_del.length+" "+item+" will be deleted");
      if (r == true) {
        // socket.emit("C_del_inbox",list_del);
      }
    }
}
function checkbox_inbox_click(idc){
    var stt=0;
    var list_checkbox = document.getElementsByClassName("line_inbox_chk");
    for (var i = 0; i < list_checkbox.length; i++) {
      if(list_checkbox[i].checked){stt++;}
    }
    if(stt >0){
      document.getElementById("id_content_inbox_del").style.display = "block";
      if(stt>1) {$("#id_content_inbox_del_item").html(stt+" items were chosen");}
      else {$("#id_content_inbox_del_item").html(stt+" item was chosen");}
  }
    else {document.getElementById("id_content_inbox_del").style.display = "none";}

}
function checkbox_online_click(idc){
    var stt=0;
    var list_checkbox = document.getElementsByClassName("line_online_chk");
    for (var i = 0; i < list_checkbox.length; i++) {
      if(list_checkbox[i].checked){stt++;}
    }
    if(stt >0){
      document.getElementById("id_content_online_del").style.display = "block";
      if(stt>1) {$("#id_content_online_del_item").html(stt+" items were chosen");}
      else {$("#id_content_onlinex_del_item").html(stt+" item was chosen");}
  }
    else {document.getElementById("id_content_online_del").style.display = "none";}

}
function checkbox_send_click(idc){
    var stt=0;
    var list_checkbox = document.getElementsByClassName("line_send_chk");
    for (var i = 0; i < list_checkbox.length; i++) {
      if(list_checkbox[i].checked){stt++;}
    }
    if(stt >0){
      document.getElementById("id_content_send_del").style.display = "block";
      if(stt>1) {$("#id_content_send_del_item").html(stt+" items were chosen");}
      else {$("#id_content_send_del_item").html(stt+" item was chosen");}
  }
    else {document.getElementById("id_content_send_del").style.display = "none";}

}
function checkbox_save_click(idc){
    var stt=0;
    var list_checkbox = document.getElementsByClassName("line_save_chk");
    for (var i = 0; i < list_checkbox.length; i++) {
      if(list_checkbox[i].checked){stt++;}
    }
    if(stt >0){
      document.getElementById("id_content_save_del").style.display = "block";
      if(stt>1) {$("#id_content_save_del_item").html(stt+" items were chosen");}
      else {$("#id_content_save_del_item").html(stt+" item was chosen");}
  }
    else {document.getElementById("id_content_save_del").style.display = "none";}

}

function show_contact_list(){
  if(document.getElementById("id_list_contact").style.display == "block"){
  document.getElementById("id_list_contact").style.display = "none";
  }
  else {
    // nếu mục chính contact không hiện, thì có 2 trường hợp: 1 là nó ẩn, và 2 là mục tìm kiếm đang hiện
      if(document.getElementById("id_list_contact_search").style.display == "block"){
        document.getElementById("id_list_contact_search").style.display = "none";
      }
      else {
        document.getElementById("id_list_contact").style.display = "block";
      }


  }
  // mang_contact.forEach((tin)=>{
  //   var chuoi  ="<div class='line_inbox' ><div style='position:absolute;left:5px;width:150px;'>"+ strdecode(tin.name) +"</div></br>"+
  //   "<div style='position:absolute; left:5px'>"+strdecode(tin.number)+"</div></div>";
  //    $("#my_list_contact").append( chuoi);
  // });
  }
function show_content_top_right(id){
  document.getElementById(id).style.display = "block";
}
window.onclick = function(event) {
  if (!event.target.matches('.btn_account')) {
    document.getElementById("id_content_account").style.display = "none";
  }
  if (!event.target.matches('.btn_online')) {
    document.getElementById("id_content_online").style.display = "none";
  }

  if (!(event.target.matches('.btn_save')||(event.target.matches('.line_save_chk')  )  )  ) {
    document.getElementById("id_content_save").style.display = "none";
  }

  if (!(event.target.matches('.btn_send')||(event.target.matches('.line_send_chk')  )  )  ) {
    document.getElementById("id_content_send").style.display = "none";
  }
  if (!(event.target.matches('.btn_inbox')||(event.target.matches('.line_inbox_chk')  )  )  ) {
    document.getElementById("id_content_inbox").style.display = "none";
  }

}
</script>
</head>
<body>
  <div class="wrapper">
    <div class="content">
      <div class="top_right">
        <div class="top_right_item">
          <button class="btn_account" onclick="show_content_top_right('id_content_account')">ACCOUNT</button>
          <div class="content_account" id="id_content_account"></div>
        </div>
        <div class="top_right_item">
          <button class="btn_online" onclick="show_content_top_right('id_content_online')">ONLINE</button>
          <div class="content_online" id="id_content_online">
            <div class="content_del" id="id_content_online_del"><div class="content_inbox_del_item" id="id_content_online_del_item"></div><button class="content_inbox_del_btn" onclick="xoadiem_room()">Del</button></div>
            <div style="height:1px; width:100px;" id="k_online"></div>
          </div>
        </div>
        <div class="top_right_item">
          <button class="btn_save" onclick="show_content_top_right('id_content_save')">SAVE</button>
          <div class="content_save" id="id_content_save">
            <div class="content_del" id="id_content_save_del"><div class="content_inbox_del_item" id="id_content_save_del_item"></div><button class="content_inbox_del_btn" onclick="xoadiem_save()">Del</button></div>
            <div style="height:1px; width:100px;" id="k_save"></div>
          </div>
        </div>
        <div class="top_right_item">
          <button class="btn_send" onclick="show_content_top_right('id_content_send')">SEND</button>
          <div class="content_send" id="id_content_send">
            <div class="content_del" id="id_content_send_del"><div class="content_inbox_del_item" id="id_content_send_del_item"></div><button class="content_inbox_del_btn" onclick="xoadiem_send()">Del</button></div>
            <div style="height:1px; width:100px;" id="k_send"></div>
          </div>
        </div>
        <div class="top_right_item">
          <button class="btn_inbox" onclick="show_content_top_right('id_content_inbox')">INBOX</button>
          <div class="content_inbox" id="id_content_inbox">
            <div class="content_del" id="id_content_inbox_del"><div class="content_inbox_del_item" id="id_content_inbox_del_item"></div><button class="content_inbox_del_btn" onclick="xoadiem_inbox()">Del</button></div>
            <div style="height:1px; width:100px;" id="k_inbox"></div>
          </div>
        </div>
      </div>
      <div class="top_left">
        <div style="position:absolute; left:10px;top:5px">Subject</div>
        <input type="text" class="input_sub" autocomplete="off" id="id_input_subject"></input>
        <button style="position:absolute;left:5px;bottom:50px" onclick="show_contact_list()">Contact</button>
        <input type="text" class="input_contact" id="id_input_contact" oninput="search_contact()" autocomplete="off"></input>
        <button style="position:absolute;height:30px;left:270px;bottom:50px" id="id_btn_save" onclick="test()">SAVE</button>
        <button style="position:absolute;height:30px;left:330px;bottom:50px" id="id_btn_send" onclick="guitinnhan()">SEND</button>
        <div class="list_contact_ok" id="id_list_contact_ok"></div>
        <div class="list_contact" id="id_list_contact"></div>
        <div class="list_contact" id="id_list_contact_search"></div>
      </div>
      <div class="right_bar" id="id_right_bar">
        <button class="btn_list" onclick="open_close_list()" id="id_btn_list">List</button>
        <div class="location_list" id="id_location_list"></div>
      </div>
    </div>
    <div id="map" class="class_map"></div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTmmp8QAjy0E7SWlcrAFjRRTzGefS4lH0&callback=myMap" type="text/javascript"></script>
  </div>

  </body>
</html>
